<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automotive Diagnostic Tree</title>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 min-h-screen p-6" x-data="diagnostic()" x-init="init()">

<div class="max-w-4xl mx-auto">
  <h1 class="text-4xl font-bold text-white text-center mb-8 drop-shadow-lg">Diagnostic Automobile</h1>

  <div x-show="path.length > 1" class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 mb-6 text-white">
    <span class="font-semibold">√âtape <span x-text="path.length > 2 ? path.length - 1 : 1"></span> du diagnostic</span>
    <template x-if="path.length > 1">
      <div class="mt-1 text-sm opacity-90">Sympt√¥me principal: <span x-text="path[1].symptome_principal || 'Racine'"></span></div>
    </template>
  </div>

  <div x-show="current" class="bg-white rounded-xl shadow-2xl p-8 mb-6">
    <template x-if="current && current.question && current.choices">
      <div>
        <div class="text-2xl font-bold text-gray-800 mb-6" x-text="current.question"></div>
        <div class="space-y-3">
          <template x-for="[key, value] in Object.entries(current.choices)" :key="key">
            <button 
              @click="navigate(value)" 
              class="w-full text-left px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium"
              x-text="key.startsWith('oui') ? 'Oui' : key.startsWith('non') ? 'Non' : value.symptome_principal">
            </button>
          </template>
        </div>
      </div>
    </template>

    <template x-if="current && current.question && !current.choices">
      <div>
        <div class="text-2xl font-bold text-gray-800 mb-6" x-text="current.question"></div>
        <div class="space-y-3">
          <button @click="navigate(current.yes)" x-show="current.yes" class="w-full text-left px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">Oui</button>
          <button @click="navigate(current.no)" x-show="current.no" class="w-full text-left px-6 py-4 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">Non</button>
          
          <button @click="navigate(current.blue)" x-show="current.blue" class="w-full text-left px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-700 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">üîµ Fum√©e Bleue</button>
          <button @click="navigate(current.white)" x-show="current.white" class="w-full text-left px-6 py-4 bg-gradient-to-r from-gray-300 to-gray-500 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">‚ö™ Fum√©e Blanche</button>
          <button @click="navigate(current.black)" x-show="current.black" class="w-full text-left px-6 py-4 bg-gradient-to-r from-gray-700 to-black text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">‚ö´ Fum√©e Noire</button>
          <button @click="navigate(current.no_smoke_but_smell)" x-show="current.no_smoke_but_smell" class="w-full text-left px-6 py-4 bg-gradient-to-r from-amber-500 to-yellow-600 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">Pas de fum√©e, seulement une odeur</button>
          <button @click="navigate(current.oil)" x-show="current.oil" class="w-full text-left px-6 py-4 bg-gradient-to-r from-gray-700 to-black text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">Fuite d'Huile</button>
          <button @click="navigate(current.coolant)" x-show="current.coolant" class="w-full text-left px-6 py-4 bg-gradient-to-r from-fuchsia-500 to-pink-600 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">Fuite de Liquide de Refroidissement</button>
          <button @click="navigate(current.fuel)" x-show="current.fuel" class="w-full text-left px-6 py-4 bg-gradient-to-r from-lime-500 to-green-600 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium">Fuite de Carburant</button>
        </div>
      </div>
    </template>

    <template x-if="current && (current.hypothese || current.hypothesis) && !current.question">
      <div class="bg-blue-50 border-l-4 border-blue-600 rounded-lg p-6">
        <h3 class="text-2xl font-bold text-blue-900 mb-4">üîç Diagnostic</h3>
        
        <template x-if="current.symptome || current.symptome_principal">
          <div class="mb-6">
            <h4 class="text-xl font-bold text-gray-800 mb-3">Sympt√¥me Identifi√©:</h4>
            <p class="text-gray-700 font-semibold" x-text="current.symptome || current.symptome_principal"></p>
          </div>
        </template>
        
        <div class="mb-6">
          <h4 class="text-xl font-bold text-gray-800 mb-3">Hypoth√®se Principale:</h4>
          <p class="text-lg text-gray-800" x-text="current.hypothese || current.hypothesis"></p>
        </div>


        <h4 class="text-xl font-bold text-gray-800 mb-3">Actions Recommand√©es:</h4>
        <ul class="space-y-3">
          <template x-for="action in current.actions || []" :key="action">
            <li class="flex items-start bg-white p-3 rounded-lg shadow">
              <span class="text-green-600 mr-2 mt-1">‚úì</span>
              <span class="text-gray-700 leading-relaxed" x-text="action"></span>
            </li>
          </template>
        </ul>
      </div>
    </template>
  </div>

  <div class="flex gap-4 justify-center">
    <button 
      @click="back()" 
      :disabled="path.length <= 1"
      class="px-8 py-3 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200 shadow-lg">
      ‚Üê Retour
    </button>
    <button 
      @click="reset()"
      class="px-8 py-3 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition duration-200 shadow-lg">
      üîÑ Recommencer
    </button>
  </div>
</div>

<script>
function diagnostic() {
  return {
    tree: null,
    path: [],
    get current() { 
      return this.path[this.path.length - 1] || null; 
    },
    async init() {
      try {
        // CHARGEMENT DU MENU PRINCIPAL MIS √Ä JOUR
        const res = await fetch('arbre/arbre.json');
        this.tree = await res.json();
        this.path = [this.tree];
      } catch (error) {
        console.error('Erreur de chargement:', error);
        alert("Impossible de charger le menu de diagnostic. V√©rifiez que 'arbre/arbre.json' est pr√©sent.");
      }
    },
    async navigate(node) {
      if (!node) return;

      if (node.file_path) {
        // CHARGEMENT DU SOUS-ARBRE MIS √Ä JOUR
        try {
          const res = await fetch('arbre/' + node.file_path);
          const subTree = await res.json();
          // 1. Pousser le n≈ìud de l'√©l√©ment de menu (pour le contexte du bouton Retour)
          this.path.push(node);
          // 2. Pousser la racine du sous-arbre comme question actuelle
          this.path.push(subTree);
        } catch (error) {
          console.error(`Erreur de chargement du sous-arbre pour ${node.file_path}:`, error);
          alert(`Impossible de charger l'arbre de diagnostic pour : ${node.symptome_principal}. V√©rifiez le chemin du fichier.`);
        }
      } else {
        // Navigation normale pour les sous-questions
        this.path.push(node);
      }
    },
    back() {
      if (this.path.length > 1) {
        // Si le n≈ìud pr√©c√©dent (avant le courant) a un 'file_path', cela signifie que nous sommes
        // √† la racine d'un sous-arbre. Nous devons reculer de deux √©tapes.
        if (this.path.length > 2 && this.path[this.path.length - 2].file_path) {
             this.path.pop(); // Retire la racine du sous-arbre
             this.path.pop(); // Retire l'√©l√©ment de menu pour revenir √† la racine
        } else {
             this.path.pop(); // Recul normal
        }
      }
    },
    reset() {
      this.path = [this.tree];
    },
    formatChoice(key) {
      // Formate la cl√© JSON en texte lisible pour le bouton
      return key
        .replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
  }
}
</script>
</body>
</html>