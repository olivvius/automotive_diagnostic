<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automotive Diagnostic Tree</title>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 min-h-screen p-6" x-data="diagnostic()" x-init="init()">

<a href="tree_view.html" class="absolute top-6 right-6 bg-white/20 backdrop-blur-sm text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-white/30 transition-colors">
  Vue Graphique
</a>

<div class="max-w-4xl mx-auto">
  <h1 class="text-4xl font-bold text-white text-center mb-8 drop-shadow-lg">Diagnostic Automobile</h1>

  <div x-show="path.length > 1" class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 mb-6 text-white">
    <span class="font-semibold">Étape <span x-text="path.length > 2 ? path.length - 1 : 1"></span> du diagnostic</span>
    <template x-if="path.length > 1">
      <div class="mt-1 text-sm opacity-90">Symptôme principal: <span x-text="path[1].symptome_principal || 'Racine'"></span></div>
    </template>
  </div>

  <div x-show="current" class="bg-white rounded-xl shadow-2xl p-8 mb-6">
    <template x-if="current && current.type === 'question'">
      <div>
        <div class="text-2xl font-bold text-gray-800 mb-6" x-text="current.question"></div>
        <div class="space-y-3">
          <template x-for="option in current.options" :key="option.id">
            <button 
              @click="navigate(option)" 
              class="w-full text-left px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:scale-105 transform transition duration-200 shadow-lg hover:shadow-xl font-medium"
              x-text="option.text">
            </button>
          </template>
        </div>
      </div>
    </template>

    <template x-if="current && current.type === 'terminal'">
      <div class="bg-blue-50 border-l-4 border-blue-600 rounded-lg p-6">
        <h3 class="text-2xl font-bold text-blue-900 mb-4">Diagnostic</h3>
        
        <template x-if="current.symptome || current.symptome_principal">
          <div class="mb-6">
            <h4 class="text-xl font-bold text-gray-800 mb-3">Symptôme Identifié:</h4>
            <p class="text-gray-700 font-semibold" x-text="current.symptome || current.symptome_principal"></p>
          </div>
        </template>
        <div class="mb-6">
          <h4 class="text-xl font-bold text-gray-800 mb-3">Diagnostic:</h4>
          <p class="text-lg text-gray-800" x-text="current.diagnostic"></p>
        </div>

        <h4 class="text-xl font-bold text-gray-800 mb-3">Actions Recommandées:</h4>
        <ul class="space-y-3">
          <template x-for="action in current.actions || []" :key="action">
            <li class="flex items-start bg-white p-3 rounded-lg shadow">
              <span class="text-green-600 mr-2 mt-1">✓</span>
              <span class="text-gray-700 leading-relaxed" x-text="action"></span>
            </li>
          </template>
        </ul>
      </div>
    </template>
  </div>

  <div class="flex gap-4 justify-center">
    <button 
      @click="back()" 
      :disabled="path.length <= 1"
      class="px-8 py-3 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200 shadow-lg">
      Retour
    </button>
    <button 
      @click="reset()"
      class="px-8 py-3 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition duration-200 shadow-lg">
      Recommencer
    </button>
  </div>
</div>

<script>
function diagnostic() {
  return {
    tree: null,
    path: [],
    get current() { 
      return this.path[this.path.length - 1] || null; 
    },
    async init() {
      try {
        const res = await fetch('arbre/arbre.json');
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const text = await res.text();
        try {
          this.tree = JSON.parse(text);
          this.path = [this.tree];
        } catch (parseError) {
          console.error('Erreur de parsing JSON:', parseError);
          alert('Le fichier arbre.json contient une erreur de syntaxe. Vérifiez la console pour plus de détails.');
        }
      } catch (error) {
        console.error('Erreur de chargement:', error);
        alert(`Erreur lors du chargement du diagnostic : ${error.message}. Vérifiez la console pour plus de détails.`);
      }
    },
    async navigate(option) {
      if (!option) return;
      if (option.file_path) {
        const res = await fetch('arbre/' + option.file_path);
        const subTree = await res.json();
        this.path.push(option);
        subTree.type = 'question';
        this.path.push(subTree);
      } else {
        this.path.push(option);
      }
    },
    back() {
      if (this.path.length > 1) {
        if (this.path.length > 2 && this.path[this.path.length - 2].file_path) {
             this.path.pop();
             this.path.pop();
        } else {
             this.path.pop(); // Recul normal
        }
      }
    },
    reset() {
      this.path = [this.tree];
    }
  }
}
</script>
</body>
</html>